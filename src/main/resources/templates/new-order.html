<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新建订单 - 干洗店管理系统</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f5f5f5; }
        .large-button { font-size: 1.3rem; padding: 0.8rem 1.5rem; margin: 0.3rem; }
        .container { max-width: 1000px; margin-top: 1rem; }
        .header { background-color: #fff; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card { margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-control, .form-select { font-size: 1.1rem; padding: 0.8rem; }
        .clothes-item { background: #f8f9fa; padding: 1rem; margin: 0.5rem 0; border-radius: 0.5rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2 class="text-center">新建订单</h2>
            <a href="/" class="btn btn-secondary">返回首页</a>
        </div>

        <!-- 客户信息 -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">客户信息</h5>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">手机号</label>
                        <input type="text" id="customerPhone" class="form-control" placeholder="输入手机号搜索客户">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="searchCustomer()">搜索客户</button>
                    </div>
                </div>
                <div id="customerInfo" style="display:none;">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">姓名</label>
                            <input type="text" id="customerName" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">微信</label>
                            <input type="text" id="customerWechat" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">余额</label>
                            <input type="text" id="customerBalance" class="form-control" readonly>
                        </div>
                    </div>
                </div>
                <div id="newCustomerForm" style="display:none;" class="mt-3">
                    <div class="alert alert-info">未找到该客户，请填写新客户信息</div>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">姓名</label>
                            <input type="text" id="newCustomerName" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">微信</label>
                            <input type="text" id="newCustomerWechat" class="form-control">
                        </div>
                    </div>
                    <button class="btn btn-success mt-2" onclick="createNewCustomer()">创建新客户</button>
                </div>
            </div>
        </div>

        <!-- 衣物信息 -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">衣物信息</h5>
                <div id="clothesList"></div>
                <button class="btn btn-outline-primary mt-2" onclick="addClothesItem()">+ 添加衣物</button>
            </div>
        </div>

        <!-- 订单汇总 -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">订单汇总</h5>
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">总价</label>
                        <input type="number" id="totalPrice" class="form-control" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">支付方式</label>
                        <select id="payType" class="form-select">
                            <option value="CASH">现金</option>
                            <option value="PREPAID">储值</option>
                            <option value="UNPAID">未支付</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">加急</label>
                        <select id="urgent" class="form-select">
                            <option value="0">否</option>
                            <option value="1">是</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-success btn-lg w-100 mt-3" onclick="submitOrder()">提交订单</button>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentCustomerId = null;
        let clothesItems = [];

        function searchCustomer() {
            const phone = document.getElementById('customerPhone').value;
            fetch(`/api/customers/search/phone/${phone}`)
                .then(res => res.json())
                .then(data => {
                    if (data.id) {
                        currentCustomerId = data.id;
                        document.getElementById('customerInfo').style.display = 'block';
                        document.getElementById('customerName').value = data.name;
                        document.getElementById('customerWechat').value = data.wechat || '';
                        document.getElementById('customerBalance').value = data.balance || 0;
                        document.getElementById('newCustomerForm').style.display = 'none';
                    } else {
                        currentCustomerId = null;
                        document.getElementById('customerInfo').style.display = 'none';
                        document.getElementById('newCustomerForm').style.display = 'block';
                    }
                })
                .catch(() => {
                    document.getElementById('customerInfo').style.display = 'none';
                    document.getElementById('newCustomerForm').style.display = 'block';
                });
        }

        function createNewCustomer() {
            const name = document.getElementById('newCustomerName').value;
            const phone = document.getElementById('customerPhone').value;
            const wechat = document.getElementById('newCustomerWechat').value;
            
            fetch('/api/customers', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name, phone, wechat, balance: 0})
            })
            .then(res => res.json())
            .then(data => {
                currentCustomerId = data.id;
                document.getElementById('customerInfo').style.display = 'block';
                document.getElementById('customerName').value = data.name;
                document.getElementById('customerWechat').value = data.wechat || '';
                document.getElementById('customerBalance').value = 0;
                document.getElementById('newCustomerForm').style.display = 'none';
                alert('客户创建成功！');
            });
        }

        function addClothesItem() {
            const index = clothesItems.length;
            clothesItems.push({type: '', price: 0, damageRemark: ''});
            
            const html = `
                <div class="clothes-item" id="clothes-${index}">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">类型</label>
                            <select class="form-select" onchange="updatePrice(${index}, this.value)">
                                <option value="">请选择</option>
                                <option value="毛衫">毛衫</option>
                                <option value="羊绒大衣 (小)">羊绒大衣 (小)</option>
                                <option value="羊绒大衣 (中)">羊绒大衣 (中)</option>
                                <option value="羊绒大衣 (大)">羊绒大衣 (大)</option>
                                <option value="皮毛一体">皮毛一体</option>
                                <option value="貂">貂</option>
                                <option value="鞋">鞋</option>
                                <option value="裤子">裤子</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">价格</label>
                            <input type="number" id="price-${index}" class="form-control" value="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">破损备注</label>
                            <input type="text" id="damage-${index}" class="form-control" placeholder="无破损可不填">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-danger w-100" onclick="removeClothes(${index})">删除</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('clothesList').insertAdjacentHTML('beforeend', html);
        }

        function updatePrice(index, type) {
            const prices = {
                '毛衫': 20,
                '羊绒大衣 (小)': 20,
                '羊绒大衣 (中)': 25,
                '羊绒大衣 (大)': 30,
                '皮毛一体': 50,
                '貂': 300,
                '鞋': 15,
                '裤子': 20
            };
            document.getElementById(`price-${index}`).value = prices[type] || 0;
            calculateTotal();
        }

        function removeClothes(index) {
            document.getElementById(`clothes-${index}`).remove();
            clothesItems.splice(index, 1);
            calculateTotal();
        }

        function calculateTotal() {
            let total = 0;
            document.querySelectorAll('[id^="price-"]').forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            document.getElementById('totalPrice').value = total;
        }

        function submitOrder() {
            if (!currentCustomerId) {
                alert('请先选择或创建客户！');
                return;
            }

            // 收集衣物数据
            const clothesItems = document.querySelectorAll('.clothes-item');
            if (clothesItems.length === 0) {
                alert('请至少添加一件衣物！');
                return;
            }

            const clothesData = [];
            clothesItems.forEach((item) => {
                const select = item.querySelector('select');
                const priceInput = item.querySelector('input[type="number"]');
                const damageInput = item.querySelector('input[type="text"]');
                
                if (select && select.value && priceInput) {
                    clothesData.push({
                        type: select.value,
                        price: parseFloat(priceInput.value) || 0,
                        damageRemark: damageInput ? damageInput.value : '',
                        status: 'UNWASHED'
                    });
                }
            });

            if (clothesData.length === 0) {
                alert('请至少添加一件有效的衣物！');
                return;
            }

            const totalPrice = parseFloat(document.getElementById('totalPrice').value);
            const payType = document.getElementById('payType').value;

            // 生成订单号：ORD-YYYYMMDD-序号
            const now = new Date();
            const dateStr = now.getFullYear() +
                           String(now.getMonth() + 1).padStart(2, '0') +
                           String(now.getDate()).padStart(2, '0');
            const randomStr = String(Math.floor(Math.random() * 1000)).padStart(3, '0');
            const orderNo = 'ORD-' + dateStr + '-' + randomStr;

            const order = {
                customerId: currentCustomerId,
                orderNo: orderNo,
                totalPrice: totalPrice,
                prepaid: 0,
                payType: payType,
                urgent: parseInt(document.getElementById('urgent').value),
                status: 'UNWASHED'
            };

            // 创建订单和衣物
            createOrderAndClothes(order, clothesData);
        }

        function createOrderAndClothes(order, clothesData) {
            // 1. 先创建订单
            fetch('/api/orders', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(order)
            })
            .then(res => {
                if (res.ok) {
                    return res.json();
                }
                // 处理后端返回的错误
                return res.text().then(text => {
                    throw new Error(text || '订单创建失败');
                });
            })
            .then(orderData => {
                console.log('订单创建成功，订单 ID:', orderData.id, '订单号:', orderData.orderNo);
                
                // 2. 确保有衣物数据
                if (!clothesData || clothesData.length === 0) {
                    alert('订单已创建，但没有衣物数据');
                    window.location.href = '/orders/search';
                    return;
                }
                
                // 3. 为每件衣物设置正确的订单号（字符串类型）
                const clothesWithOrderNo = clothesData.map(c => {
                    const clothes = {
                        orderId: orderData.orderNo,
                        type: c.type,
                        price: Number(c.price),
                        damageRemark: c.damageRemark || '',
                        status: c.status || 'UNWASHED'
                    };
                    console.log('准备创建衣物:', JSON.stringify(clothes));
                    return clothes;
                });
                
                console.log('所有衣物数据:', JSON.stringify(clothesWithOrderNo));
                
                const promises = clothesWithOrderNo.map(clothes => {
                    return fetch('/api/clothes', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(clothes)
                    })
                    .then(res => {
                        if (!res.ok) {
                            return res.text().then(text => {
                                throw new Error(text || '衣物创建失败');
                            });
                        }
                        return res.json();
                    })
                    .then(data => {
                        console.log('衣物创建成功:', data);
                        return data;
                    });
                });

                // 4. 等待所有衣物创建完成
                return Promise.all(promises)
                    .then(clothesResults => {
                        console.log('所有衣物创建成功:', clothesResults);
                        alert('订单创建成功！订单号：' + orderData.orderNo);
                        window.location.href = '/orders/search';
                    })
                    .catch(err => {
                        console.error('Error adding clothes:', err);
                        alert('订单已创建（订单号：' + orderData.orderNo + '），但衣物添加失败：' + err.message);
                        window.location.href = '/orders/search';
                    });
            })
            .catch(err => {
                console.error('Error creating order:', err);
                alert('订单创建失败：' + err.message);
            });
        }
    </script>
</body>
</html>
