<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>仪表板 - 干洗店管理系统</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f5f5f5; }
        .large-button { font-size: 1.5rem; padding: 1rem 2rem; margin: 0.5rem; }
        .container { max-width: 1200px; margin-top: 2rem; }
        .header { background-color: #fff; padding: 1rem; border-radius: 0.5rem; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-card { background: #fff; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-value { font-size: 2rem; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="text-center">干洗店管理系统</h1>
            <p class="text-center text-muted">高效管理客户、订单和衣物信息</p>
        </div>

        <!-- 快速统计 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card text-center">
                    <div class="stat-value text-primary" id="todayIncome">¥0</div>
                    <div class="text-muted">今日收入</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card text-center">
                    <div class="stat-value text-warning" id="unfinishedOrders">0</div>
                    <div class="text-muted">未完成订单</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card text-center">
                    <div class="stat-value text-info" id="todayOrders">0</div>
                    <div class="text-muted">今日订单</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card text-center">
                    <div class="stat-value text-success" id="totalCustomers">0</div>
                    <div class="text-muted">总客户数</div>
                </div>
            </div>
        </div>

        <!-- 主要功能 -->
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-body text-center">
                        <h5 class="card-title">订单管理</h5>
                        <p class="card-text">创建新订单或搜索现有订单</p>
                        <a href="/orders/new" class="btn btn-success large-button">新建订单</a>
                        <a href="/orders/search" class="btn btn-info large-button">搜索订单</a>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-body text-center">
                        <h5 class="card-title">客户管理</h5>
                        <p class="card-text">添加、编辑和查看客户信息</p>
                        <a href="/customers" class="btn btn-primary large-button">客户管理</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-body text-center">
                        <h5 class="card-title">统计报表</h5>
                        <p class="card-text">查看收入统计和订单状态</p>
                        <a href="/statistics" class="btn btn-warning large-button">统计报表</a>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-body text-center">
                        <h5 class="card-title">会员充值</h5>
                        <p class="card-text">为客户进行储值充值（充 100 送 20%）</p>
                        <button class="btn btn-secondary large-button" onclick="showRechargeModal()">会员充值</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 充值模态框 -->
        <div class="modal fade" id="rechargeModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">会员充值</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">客户 ID</label>
                            <input type="number" id="rechargeCustomerId" class="form-control" placeholder="输入客户 ID">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">充值金额</label>
                            <input type="number" id="rechargeAmount" class="form-control" placeholder="输入充值金额">
                        </div>
                        <div class="alert alert-info">
                            充值优惠：充 100 送 20%<br>
                            例如：充值 100 元，实际到账 120 元
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="doRecharge()">确认充值</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        function loadDashboardStats() {
            const today = new Date().toISOString().split('T')[0];
            
            // 今日收入
            fetch(`/api/statistics/daily-income?date=${today}`)
                .then(res => res.json())
                .then(income => {
                    document.getElementById('todayIncome').textContent = '¥' + income.toFixed(0);
                });

            // 未完成订单
            fetch('/api/statistics/unfinished-orders-count')
                .then(res => res.json())
                .then(count => {
                    document.getElementById('unfinishedOrders').textContent = count;
                });

            // 今日订单数（简化处理，使用未完成订单数代替）
            document.getElementById('todayOrders').textContent = '-';

            // 总客户数
            fetch('/api/customers')
                .then(res => res.json())
                .then(customers => {
                    document.getElementById('totalCustomers').textContent = customers.length;
                });
        }

        function showRechargeModal() {
            new bootstrap.Modal(document.getElementById('rechargeModal')).show();
        }

        function doRecharge() {
            const customerId = document.getElementById('rechargeCustomerId').value;
            const amount = document.getElementById('rechargeAmount').value;
            
            if (!customerId || !amount) {
                alert('请填写客户 ID 和充值金额');
                return;
            }

            fetch(`/api/prepaid/recharge?customerId=${customerId}&amount=${amount}`, {method: 'POST'})
                .then(res => {
                    if (res.ok) {
                        return res.text();
                    }
                    throw new Error('充值失败');
                })
                .then(msg => {
                    alert(msg);
                    bootstrap.Modal.getInstance(document.getElementById('rechargeModal')).hide();
                })
                .catch(err => {
                    alert('充值失败：' + err.message);
                });
        }

        loadDashboardStats();
    </script>
</body>
</html>
