<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新建订单 - 干洗店管理系统</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f5f5f5; }
        .large-button { font-size: 1.3rem; padding: 0.8rem 1.5rem; margin: 0.3rem; }
        .container { max-width: 1000px; margin-top: 1rem; }
        .header { background-color: #fff; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card { margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-control, .form-select { font-size: 1.1rem; padding: 0.8rem; }
        .clothes-item { background: #f8f9fa; padding: 1rem; margin: 0.5rem 0; border-radius: 0.5rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2 class="text-center">新建订单</h2>
            <a href="/dashboard" class="btn btn-secondary">返回仪表板</a>
        </div>

        <!-- 客户信息 -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">客户信息</h5>
                <div class="alert alert-info py-2 mb-3">
                    <small>请输入手机号或姓名/拼音进行搜索，至少填写一项</small>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">手机号</label>
                        <input type="text" id="customerPhone" class="form-control" placeholder="输入手机号搜索">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="searchByPhone()">手机号搜索</button>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">姓名/拼音</label>
                        <input type="text" id="customerNameSearch" class="form-control" placeholder="输入姓名或拼音（如：zs）">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-success w-100" onclick="searchByNameOrPinyin()">姓名/拼音搜索</button>
                    </div>
                </div>
                
                <!-- 客户选择区域（搜索到多个客户时显示） -->
                <div id="customerSelectionArea" style="display:none;" class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0">请选择客户：</label>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">重新选择</button>
                    </div>
                    <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                        <div id="customerCheckboxList">
                            <!-- 复选框列表将动态生成 -->
                        </div>
                    </div>
                    <div class="form-text">找到 <span id="customerCount">0</span> 个客户，请勾选对应的客户</div>
                </div>
                
                <div id="customerInfo" style="display:none;">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">姓名</label>
                            <input type="text" id="customerName" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">微信</label>
                            <input type="text" id="customerWechat" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">余额</label>
                            <input type="text" id="customerBalance" class="form-control" readonly>
                        </div>
                    </div>
                </div>
                <div id="newCustomerForm" style="display:none;" class="mt-3">
                    <div class="alert alert-info">未找到该客户，请填写新客户信息<br><small class="text-muted">姓名和手机号至少填写一项</small></div>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">姓名</label>
                            <input type="text" id="newCustomerName" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">手机号</label>
                            <input type="text" id="newCustomerPhone" class="form-control">
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <label class="form-label">微信 <span class="text-muted">(选填)</span></label>
                            <input type="text" id="newCustomerWechat" class="form-control">
                        </div>
                    </div>
                    <button class="btn btn-success mt-2" onclick="createNewCustomer()">创建新客户</button>
                </div>
            </div>
        </div>

        <!-- 衣物信息 -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">衣物信息</h5>
                <div id="clothesList"></div>
                <button class="btn btn-outline-primary mt-2" onclick="addClothesItem()">+ 添加衣物</button>
            </div>
        </div>

        <!-- 订单汇总 -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">订单汇总</h5>
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">总价</label>
                        <input type="number" id="totalPrice" class="form-control" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">支付方式</label>
                        <select id="payType" class="form-select">
                            <option value="CASH">现金</option>
                            <option value="PREPAID">储值</option>
                            <option value="UNPAID">未支付</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">加急</label>
                        <select id="urgent" class="form-select">
                            <option value="0">否</option>
                            <option value="1">是</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-success btn-lg w-100 mt-3" onclick="submitOrder()">提交订单</button>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentCustomerId = null;
        let clothesItems = [];
        let searchResults = []; // 存储搜索结果用于选择
        let currentSearchCount = 0; // 当前搜索结果数量

        // 清空选择
        function clearSelection() {
            currentCustomerId = null;
            document.getElementById('customerInfo').style.display = 'none';
            document.getElementById('customerSelectionArea').style.display = 'block';
            document.getElementById('customerCheckboxList').innerHTML = '';
            document.getElementById('customerCount').textContent = currentSearchCount;
            
            // 清空搜索框
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerNameSearch').value = '';
        }

        // 按手机号搜索（支持模糊查询）
        function searchByPhone() {
            const phone = document.getElementById('customerPhone').value;
            if (!phone) {
                alert('请输入手机号，或使用姓名/拼音搜索');
                return;
            }
            // 使用模糊搜索接口，支持手机号模糊匹配
            fetch(`/api/customers/search/fuzzy?phone=${encodeURIComponent(phone)}`)
                .then(res => res.json())
                .then(customers => {
                    console.log('手机号搜索到客户数量:', customers.length, customers);
                    if (customers && customers.length > 0) {
                        searchResults = customers;
                        // 显示选择列表让用户勾选
                        showCustomerSelection(customers);
                    } else {
                        showNewCustomerForm();
                    }
                })
                .catch(err => {
                    console.error('Search error:', err);
                    alert('搜索失败：' + err.message);
                });
        }

        // 按姓名或拼音搜索（使用模糊搜索接口，支持多结果）
        function searchByNameOrPinyin() {
            const keyword = document.getElementById('customerNameSearch').value.trim();
            if (!keyword) {
                alert('请输入姓名或拼音，或使用手机号搜索');
                return;
            }
            // 使用模糊搜索接口，支持拼音
            fetch(`/api/customers/search/fuzzy?name=${encodeURIComponent(keyword)}`)
                .then(res => res.json())
                .then(customers => {
                    console.log('姓名搜索到客户数量:', customers.length, customers);
                    if (customers && customers.length > 0) {
                        searchResults = customers;
                        // 无论多少个结果，都显示选择列表让用户勾选
                        showCustomerSelection(customers);
                    } else {
                        showNewCustomerForm();
                    }
                })
                .catch(err => {
                    console.error('Search error:', err);
                    alert('搜索失败：' + err.message);
                });
        }

        // 显示客户选择列表（复选框形式）
        function showCustomerSelection(customers) {
            const checkboxList = document.getElementById('customerCheckboxList');
            const selectionArea = document.getElementById('customerSelectionArea');
            const countSpan = document.getElementById('customerCount');
            
            // 保存搜索结果数量
            currentSearchCount = customers.length;
            
            // 清空列表
            checkboxList.innerHTML = '';
            
            // 添加复选框
            customers.forEach((c, index) => {
                const div = document.createElement('div');
                div.className = 'form-check mb-2';
                
                const checkbox = document.createElement('input');
                checkbox.className = 'form-check-input';
                checkbox.type = 'radio';
                checkbox.name = 'customerSelect';
                checkbox.id = 'customer_' + c.id;
                checkbox.value = c.id;
                checkbox.onclick = function() { selectCustomer(c); };
                
                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.htmlFor = 'customer_' + c.id;
                
                const pinyin = getPinyinInitials(c.name);
                label.textContent = `${c.name} (手机：${c.phone || '-'}, 拼音：${pinyin}, 余额：¥${c.balance || 0})`;
                
                div.appendChild(checkbox);
                div.appendChild(label);
                checkboxList.appendChild(div);
            });
            
            countSpan.textContent = customers.length;
            selectionArea.style.display = 'block';
            
            // 隐藏客户信息区域，等待用户选择
            document.getElementById('customerInfo').style.display = 'none';
            document.getElementById('newCustomerForm').style.display = 'none';
        }

        // 选中客户
        function selectCustomer(customer) {
            currentCustomerId = customer.id;
            document.getElementById('customerInfo').style.display = 'block';
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerWechat').value = customer.wechat || '';
            document.getElementById('customerBalance').value = customer.balance || 0;
            document.getElementById('newCustomerForm').style.display = 'none';
            // 更新提示信息
            document.getElementById('customerCount').textContent = currentSearchCount + '（已选择：' + customer.name + '）';
        }

        // 显示新客户表单
        function showNewCustomerForm() {
            currentCustomerId = null;
            document.getElementById('customerInfo').style.display = 'none';
            document.getElementById('customerSelectionArea').style.display = 'none';
            document.getElementById('newCustomerForm').style.display = 'block';
        }

        function createNewCustomer() {
            const name = document.getElementById('newCustomerName').value.trim();
            const phone = document.getElementById('newCustomerPhone').value.trim();
            const wechat = document.getElementById('newCustomerWechat').value.trim();

            // 验证：姓名和手机号至少填一个
            if (!name && !phone) {
                alert('姓名和手机号至少填写一项！');
                return;
            }

            fetch('/api/customers', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: name || null, phone: phone || null, wechat: wechat || null, balance: 0})
            })
            .then(res => res.json())
            .then(data => {
                currentCustomerId = data.id;
                document.getElementById('customerInfo').style.display = 'block';
                document.getElementById('customerName').value = data.name || '';
                document.getElementById('customerWechat').value = data.wechat || '';
                document.getElementById('customerBalance').value = 0;
                document.getElementById('newCustomerForm').style.display = 'none';
                alert('客户创建成功！');
            });
        }

        function addClothesItem() {
            const index = clothesItems.length;
            clothesItems.push({type: '', price: 0, damageRemark: ''});
            
            const html = `
                <div class="clothes-item" id="clothes-${index}">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">类型</label>
                            <select class="form-select" onchange="updatePrice(${index}, this.value)">
                                <option value="">请选择</option>
                                <option value="毛衫">毛衫</option>
                                <option value="羊绒大衣 (小)">羊绒大衣 (小)</option>
                                <option value="羊绒大衣 (中)">羊绒大衣 (中)</option>
                                <option value="羊绒大衣 (大)">羊绒大衣 (大)</option>
                                <option value="皮毛一体">皮毛一体</option>
                                <option value="貂">貂</option>
                                <option value="鞋">鞋</option>
                                <option value="裤子">裤子</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">价格</label>
                            <input type="number" id="price-${index}" class="form-control" value="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">破损备注</label>
                            <input type="text" id="damage-${index}" class="form-control" placeholder="无破损可不填">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-danger w-100" onclick="removeClothes(${index})">删除</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('clothesList').insertAdjacentHTML('beforeend', html);
        }

        function updatePrice(index, type) {
            const prices = {
                '毛衫': 20,
                '羊绒大衣 (小)': 20,
                '羊绒大衣 (中)': 25,
                '羊绒大衣 (大)': 30,
                '皮毛一体': 50,
                '貂': 300,
                '鞋': 15,
                '裤子': 20
            };
            document.getElementById(`price-${index}`).value = prices[type] || 0;
            calculateTotal();
        }

        function removeClothes(index) {
            document.getElementById(`clothes-${index}`).remove();
            clothesItems.splice(index, 1);
            calculateTotal();
        }

        function calculateTotal() {
            let total = 0;
            document.querySelectorAll('[id^="price-"]').forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            document.getElementById('totalPrice').value = total;
        }

        function submitOrder() {
            if (!currentCustomerId) {
                alert('请先选择或创建客户！');
                return;
            }

            // 收集衣物数据
            const clothesItems = document.querySelectorAll('.clothes-item');
            if (clothesItems.length === 0) {
                alert('请至少添加一件衣物！');
                return;
            }

            const clothesData = [];
            clothesItems.forEach((item) => {
                const select = item.querySelector('select');
                const priceInput = item.querySelector('input[type="number"]');
                const damageInput = item.querySelector('input[type="text"]');
                
                if (select && select.value && priceInput) {
                    clothesData.push({
                        type: select.value,
                        price: parseFloat(priceInput.value) || 0,
                        damageRemark: damageInput ? damageInput.value : '',
                        status: 'UNWASHED'
                    });
                }
            });

            if (clothesData.length === 0) {
                alert('请至少添加一件有效的衣物！');
                return;
            }

            const totalPrice = parseFloat(document.getElementById('totalPrice').value);
            const payType = document.getElementById('payType').value;

            // 生成订单号：ORD-YYYYMMDD-序号
            const now = new Date();
            const dateStr = now.getFullYear() +
                           String(now.getMonth() + 1).padStart(2, '0') +
                           String(now.getDate()).padStart(2, '0');
            const randomStr = String(Math.floor(Math.random() * 1000)).padStart(3, '0');
            const orderNo = 'ORD-' + dateStr + '-' + randomStr;

            const order = {
                customerId: currentCustomerId,
                orderNo: orderNo,
                totalPrice: totalPrice,
                prepaid: 0,
                payType: payType,
                urgent: parseInt(document.getElementById('urgent').value),
                status: 'UNWASHED'
            };

            // 创建订单和衣物
            createOrderAndClothes(order, clothesData);
        }

        function createOrderAndClothes(order, clothesData) {
            // 1. 先创建订单
            fetch('/api/orders', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(order)
            })
            .then(res => {
                if (res.ok) {
                    return res.json();
                }
                // 处理后端返回的错误
                return res.text().then(text => {
                    throw new Error(text || '订单创建失败');
                });
            })
            .then(orderData => {
                console.log('订单创建成功，订单 ID:', orderData.id, '订单号:', orderData.orderNo);
                
                // 2. 确保有衣物数据
                if (!clothesData || clothesData.length === 0) {
                    alert('订单已创建，但没有衣物数据');
                    window.location.href = '/orders/search';
                    return;
                }
                
                // 3. 为每件衣物设置正确的订单号（字符串类型）
                const clothesWithOrderNo = clothesData.map(c => {
                    const clothes = {
                        orderId: orderData.orderNo,
                        type: c.type,
                        price: Number(c.price),
                        damageRemark: c.damageRemark || '',
                        status: c.status || 'UNWASHED'
                    };
                    console.log('准备创建衣物:', JSON.stringify(clothes));
                    return clothes;
                });
                
                console.log('所有衣物数据:', JSON.stringify(clothesWithOrderNo));
                
                const promises = clothesWithOrderNo.map(clothes => {
                    return fetch('/api/clothes', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(clothes)
                    })
                    .then(res => {
                        if (!res.ok) {
                            return res.text().then(text => {
                                throw new Error(text || '衣物创建失败');
                            });
                        }
                        return res.json();
                    })
                    .then(data => {
                        console.log('衣物创建成功:', data);
                        return data;
                    });
                });

                // 4. 等待所有衣物创建完成
                return Promise.all(promises)
                    .then(clothesResults => {
                        console.log('所有衣物创建成功:', clothesResults);
                        alert('订单创建成功！订单号：' + orderData.orderNo);
                        window.location.href = '/orders/search';
                    })
                    .catch(err => {
                        console.error('Error adding clothes:', err);
                        alert('订单已创建（订单号：' + orderData.orderNo + '），但衣物添加失败：' + err.message);
                        window.location.href = '/orders/search';
                    });
            })
            .catch(err => {
                console.error('Error creating order:', err);
                alert('订单创建失败：' + err.message);
            });
        }

        // 获取拼音首字母（前端显示用）
        function getPinyinInitials(chinese) {
            const pinyinMap = {
                '张': 'z', '三': 's', '李': 'l', '四': 's', '王': 'w', '五': 'w',
                '赵': 'z', '钱': 'q', '孙': 's', '李': 'l', '周': 'z', '吴': 'w',
                '郑': 'z', '王': 'w', '冯': 'f', '陈': 'c', '褚': 'c', '卫': 'w'
            };
            let initials = '';
            for (let char of chinese) {
                initials += pinyinMap[char] || char;
            }
            return initials;
        }
    </script>
</body>
</html>
